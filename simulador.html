<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Simulador riesgo - recompensa</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Importar componentes -->
    <script src="components/NavHeader.js"></script>
    <script src="components/FooterComponent.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="app" class="pb-16">
      <!-- Usar componente nav -->
      <nav-header></nav-header>

      <!-- Espaciador para compensar el nav fijo -->
      <div class="h-16"></div>

      <!-- Sistema de notificaciones -->
      <div v-if="notification" class="fixed top-20 right-4 z-50 max-w-sm">
        <div
          :class="{
          'p-4 rounded-lg shadow-lg border flex items-start gap-3 transition-all duration-300': true,
          'bg-red-50 border-red-300 text-red-800': notification.type === 'error',
          'bg-yellow-50 border-yellow-300 text-yellow-800': notification.type === 'warning',
          'bg-green-50 border-green-300 text-green-800': notification.type === 'success'
        }"
        >
          <div class="flex-shrink-0 mt-0.5">
            <i
              v-if="notification.type === 'error'"
              data-lucide="alert-circle"
              class="w-5 h-5"
            ></i>
            <i
              v-if="notification.type === 'warning'"
              data-lucide="alert-triangle"
              class="w-5 h-5"
            ></i>
            <i
              v-if="notification.type === 'success'"
              data-lucide="check-circle"
              class="w-5 h-5"
            ></i>
          </div>
          <div>
            <h3 class="font-semibold">{{ notification.title }}</h3>
            <p class="text-sm">{{ notification.message }}</p>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-center px-4 py-8">
        <div
          class="bg-white shadow-md rounded p-6 max-w-7xl w-full grid grid-cols-1 md:grid-cols-3 gap-6"
        >
          <!-- Columna principal -->
          <div class="md:col-span-2">
            <h1 class="text-2xl font-bold mb-6 text-center">
              Simulador de riesgo - recompensa
            </h1>

            <!-- Grid para par y dirección -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- Selector de par -->
              <div class="relative">
                <label class="block font-semibold mb-1"
                  >Par de divisas o activo</label
                >
                <span class="absolute left-3 top-10 text-gray-500">
                  <i data-lucide="globe" class="w-4 h-4"></i>
                </span>
                <select
                  v-model="pair"
                  @focus="setAyuda('pair')"
                  @change="updateInputSteps"
                  class="w-full pl-10 border border-gray-300 rounded p-2"
                  :class="{'border-red-500': errors.pair}"
                >
                  <option disabled value="">-- Selecciona un par --</option>
                  <option
                    v-for="(info, key) in pipTable"
                    :key="key"
                    :value="key"
                  >
                    {{ key }}
                  </option>
                </select>
                <p v-if="errors.pair" class="text-red-500 text-xs mt-1">
                  {{ errors.pair }}
                </p>
              </div>

              <!-- Selector de dirección -->
              <div class="relative">
                <label class="block font-semibold mb-1"
                  >Dirección de la operación</label
                >
                <span class="absolute left-3 top-10 text-gray-500">
                  <i data-lucide="move-vertical" class="w-4 h-4"></i>
                </span>
                <select
                  v-model="direccion"
                  @focus="setAyuda('direccion')"
                  class="w-full pl-10 border border-gray-300 rounded p-2"
                  :class="{'border-red-500': errors.direccion}"
                >
                  <option value="compra">Compra (Long)</option>
                  <option value="venta">Venta (Short)</option>
                </select>
                <p v-if="errors.direccion" class="text-red-500 text-xs mt-1">
                  {{ errors.direccion }}
                </p>
              </div>
            </div>

            <!-- Inputs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div class="relative">
                <label class="block font-semibold mb-1">Tamaño del lote</label>
                <span class="absolute left-3 top-10 text-gray-500">
                  <i data-lucide="layers" class="w-4 h-4"></i>
                </span>
                <input
                  v-model.number="lote"
                  @focus="setAyuda('lote')"
                  type="number"
                  step="0.01"
                  min="0.01"
                  max="100"
                  class="w-full text-right pl-10 border border-gray-300 rounded p-2"
                  :class="{'border-red-500': errors.lote}"
                />
                <p v-if="errors.lote" class="text-red-500 text-xs mt-1">
                  {{ errors.lote }}
                </p>
              </div>

              <div class="relative">
                <label class="block font-semibold mb-1"
                  >Precio de entrada</label
                >
                <span class="absolute left-3 top-10 text-gray-500">
                  <i data-lucide="arrow-right-circle" class="w-4 h-4"></i>
                </span>
                <input
                  v-model.number="entrada"
                  @focus="setAyuda('entrada')"
                  type="number"
                  :step="getPipSize()"
                  class="w-full text-right pl-10 border border-gray-300 rounded p-2"
                  :class="{'border-red-500': errors.entrada}"
                />
                <p v-if="errors.entrada" class="text-red-500 text-xs mt-1">
                  {{ errors.entrada }}
                </p>
              </div>

              <div class="relative">
                <label class="block font-semibold mb-1"
                  >Stop loss (precio)</label
                >
                <span class="absolute left-3 top-10 text-gray-500">
                  <i data-lucide="arrow-down-circle" class="w-4 h-4"></i>
                </span>
                <input
                  v-model.number="stop"
                  @focus="setAyuda('stop')"
                  type="number"
                  :step="getPipSize()"
                  class="w-full text-right pl-10 border border-gray-300 rounded p-2"
                  :class="{'border-red-500': errors.stop}"
                />
                <p v-if="errors.stop" class="text-red-500 text-xs mt-1">
                  {{ errors.stop }}
                </p>
              </div>

              <div class="relative">
                <label class="block font-semibold mb-1"
                  >Take profit (precio)</label
                >
                <span class="absolute left-3 top-10 text-gray-500">
                  <i data-lucide="arrow-up-circle" class="w-4 h-4"></i>
                </span>
                <input
                  v-model.number="take"
                  @focus="setAyuda('take')"
                  type="number"
                  :step="getPipSize()"
                  class="w-full text-right pl-10 border border-gray-300 rounded p-2"
                  :class="{'border-red-500': errors.take}"
                />
                <p v-if="errors.take" class="text-red-500 text-xs mt-1">
                  {{ errors.take }}
                </p>
              </div>
            </div>

            <!-- Botones -->
            <div class="text-center mb-6 space-x-4">
              <button
                @click="simular"
                :disabled="!isFormValid"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 inline-flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                Simular riesgo - recompensa
              </button>

              <button
                @click="cargarUltimaSimulacion"
                v-if="haySimulacionGuardada"
                class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 inline-flex items-center gap-2"
              >
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                Cargar última
              </button>

              <button
                @click="limpiarFormulario"
                class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 inline-flex items-center gap-2"
              >
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                Limpiar
              </button>
            </div>

            <!-- Resultados -->
            <div
              v-if="resultado"
              class="text-sm bg-gray-100 border border-gray-300 p-4 rounded mb-6"
            >
              <p>
                <strong>Riesgo:</strong> {{ resultado.pipsRiesgo.toFixed(2) }}
                pips → ${{ resultado.riesgoUSD.toFixed(2) }}
              </p>
              <p>
                <strong>Recompensa:</strong> {{
                resultado.pipsRecompensa.toFixed(2) }} pips → ${{
                resultado.gananciaUSD.toFixed(2) }}
              </p>
              <p>
                <strong>Relación R:R:</strong> {{ resultado.relacion.toFixed(2)
                }}
              </p>
              <p class="mt-2 font-medium" :class="resultado.colorClass">
                {{ resultado.recomendacion }}
              </p>
            </div>
          </div>

          <!-- Ayuda contextual -->
          <div
            class="bg-gray-100 border border-gray-300 p-4 rounded text-sm leading-relaxed"
          >
            <h2 class="font-bold text-lg mb-2">Ayuda contextual</h2>
            <p v-if="ayudaActiva">{{ ayudas[ayudaActiva] }}</p>
            <p v-else class="text-gray-500">
              Enfoca un campo para ver la explicación.
            </p>
          </div>
        </div>
      </div>

      <!-- Usar componente footer -->
      <footer-component></footer-component>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        components: {
          "nav-header": NavHeader,
          "footer-component": FooterComponent,
        },
        data() {
          // Función auxiliar para obtener valor del localStorage
          const getStorageValue = (key, defaultValue = null) => {
            try {
              const value = window.localStorage.getItem(key);
              return value
                ? key.includes("_numero_")
                  ? Number(value)
                  : value
                : defaultValue;
            } catch (e) {
              console.warn("Error accediendo a localStorage:", e);
              return defaultValue;
            }
          };

          return {
            pair: getStorageValue("simulador_pair", ""),
            direccion: getStorageValue("simulador_direccion", "compra"),
            lote: getStorageValue("simulador_numero_lote", null),
            entrada: getStorageValue("simulador_numero_entrada", null),
            stop: getStorageValue("simulador_numero_stop", null),
            take: getStorageValue("simulador_numero_take", null),
            ayudaActiva: "",
            resultado: null,
            notification: null,
            errors: {
              pair: "",
              direccion: "",
              lote: "",
              entrada: "",
              stop: "",
              take: "",
            },
            pipTable: {
              EURUSD: { valorPip: 10, decimales: 4, min: 0.5, max: 2 },
              GBPUSD: { valorPip: 10, decimales: 4, min: 0.5, max: 2 },
              USDJPY: { valorPip: 9.13, decimales: 2, min: 50, max: 200 },
              GBPJPY: { valorPip: 9.13, decimales: 2, min: 50, max: 200 },
              AUDUSD: { valorPip: 10, decimales: 4, min: 0.5, max: 1.5 },
              NZDUSD: { valorPip: 10, decimales: 4, min: 0.5, max: 1.5 },
              USDCHF: { valorPip: 10, decimales: 4, min: 0.5, max: 2 },
              USDCAD: { valorPip: 10, decimales: 4, min: 0.5, max: 2 },
              XAUUSD: { valorPip: 1, decimales: 2, min: 1000, max: 3000 },
              XAGUSD: { valorPip: 5, decimales: 3, min: 10, max: 50 },
              XAUEUR: { valorPip: 1, decimales: 2, min: 1000, max: 3000 },
              XAGEUR: { valorPip: 5, decimales: 3, min: 10, max: 50 },
            },
            ayudas: {
              pair: "El par de divisas o activo que estás operando determina el valor del pip. Por ejemplo, un pip en EUR/USD vale $10 por lote estándar.",
              direccion:
                "En una compra (long) ganas si el precio sube y pierdes si baja. En una venta (short) ganas si el precio baja y pierdes si sube.",
              lote: "Cuanto mayor el tamaño del lote, mayor será el impacto económico de los movimientos de precio. 1 lote estándar son 100.000 unidades (Forex).",
              entrada:
                "El precio de entrada es el punto donde abrirías la operación. Desde aquí se calcula el riesgo y la recompensa.",
              stop: "Es el precio al cual cerrarías la operación si sale mal. En compras debe estar por debajo de la entrada, en ventas por encima.",
              take: "Es el precio al cual cerrarías la operación con ganancia. En compras debe estar por encima de la entrada, en ventas por debajo.",
            },
          };
        },
        computed: {
          isFormValid() {
            return (
              this.pair &&
              this.direccion &&
              this.lote > 0 &&
              this.entrada > 0 &&
              this.stop > 0 &&
              this.take > 0 &&
              Object.values(this.errors).every((error) => !error)
            );
          },
          haySimulacionGuardada() {
            try {
              return Boolean(
                window.localStorage.getItem("simulador_ultimo_resultado")
              );
            } catch (e) {
              return false;
            }
          },
        },
        methods: {
          setAyuda(id) {
            this.ayudaActiva = id;
          },
          showNotification(type, title, message, duration = 5000) {
            this.notification = { type, title, message };
            setTimeout(() => {
              this.notification = null;
            }, duration);
          },
          getPipSize() {
            if (!this.pair) return "0.0001";
            return Math.pow(10, -this.pipTable[this.pair].decimales).toString();
          },
          validateInputs() {
            this.errors = {
              pair: "",
              direccion: "",
              lote: "",
              entrada: "",
              stop: "",
              take: "",
            };

            if (!this.pair) {
              this.errors.pair = "Selecciona un par de divisas";
              return false;
            }

            if (!this.direccion) {
              this.errors.direccion = "Selecciona la dirección de la operación";
              return false;
            }

            if (!this.lote || this.lote <= 0) {
              this.errors.lote = "El tamaño del lote debe ser mayor que 0";
              return false;
            }
            if (this.lote > 100) {
              this.errors.lote = "El tamaño del lote no debe exceder 100";
              return false;
            }

            const info = this.pipTable[this.pair];

            if (!this.entrada || this.entrada <= 0) {
              this.errors.entrada = "El precio de entrada debe ser mayor que 0";
              return false;
            }
            if (this.entrada < info.min || this.entrada > info.max) {
              this.errors.entrada = `El precio debe estar entre ${info.min} y ${info.max}`;
              return false;
            }

            if (!this.stop || this.stop <= 0) {
              this.errors.stop = "El stop loss debe ser mayor que 0";
              return false;
            }
            if (this.stop < info.min || this.stop > info.max) {
              this.errors.stop = `El precio debe estar entre ${info.min} y ${info.max}`;
              return false;
            }

            if (!this.take || this.take <= 0) {
              this.errors.take = "El take profit debe ser mayor que 0";
              return false;
            }
            if (this.take < info.min || this.take > info.max) {
              this.errors.take = `El precio debe estar entre ${info.min} y ${info.max}`;
              return false;
            }

            // Validar que el stop y take estén en la posición correcta según la dirección
            if (this.direccion === "compra") {
              if (this.stop >= this.entrada) {
                this.errors.stop =
                  "En una compra, el stop loss debe estar por debajo del precio de entrada";
                return false;
              }
              if (this.take <= this.entrada) {
                this.errors.take =
                  "En una compra, el take profit debe estar por encima del precio de entrada";
                return false;
              }
            } else {
              // venta
              if (this.stop <= this.entrada) {
                this.errors.stop =
                  "En una venta, el stop loss debe estar por encima del precio de entrada";
                return false;
              }
              if (this.take >= this.entrada) {
                this.errors.take =
                  "En una venta, el take profit debe estar por debajo del precio de entrada";
                return false;
              }
            }

            return true;
          },
          updateInputSteps() {
            if (this.pair) {
              const pipSize = this.getPipSize();
              // Limpiar valores anteriores si el par cambia
              this.entrada = null;
              this.stop = null;
              this.take = null;
              this.resultado = null;
            }
          },
          simular() {
            if (!this.validateInputs()) {
              this.showNotification(
                "error",
                "Error de validación",
                "Por favor, corrige los errores señalados."
              );
              return;
            }

            const info = this.pipTable[this.pair];
            const pipSize = Math.pow(10, -info.decimales);

            // Calcular pips según la dirección
            const pipsRiesgo = Math.abs(this.entrada - this.stop) / pipSize;
            const pipsRecompensa = Math.abs(this.take - this.entrada) / pipSize;

            // Calcular ganancias/pérdidas según la dirección
            const riesgoUSD = pipsRiesgo * info.valorPip * this.lote;
            const gananciaUSD = pipsRecompensa * info.valorPip * this.lote;

            const relacion = gananciaUSD / riesgoUSD;

            let recomendacion = "";
            let colorClass = "";

            if (relacion < 1) {
              recomendacion =
                "❌ Riesgo no justificado: estás arriesgando más de lo que puedes ganar.";
              colorClass = "text-red-600";
            } else if (relacion >= 1 && relacion < 2) {
              recomendacion =
                "⚠️ Riesgo equilibrado: asegúrate de que esta operación tenga alta probabilidad.";
              colorClass = "text-yellow-600";
            } else {
              recomendacion =
                "✅ Excelente relación: tu recompensa supera ampliamente el riesgo asumido.";
              colorClass = "text-green-600";
            }

            this.resultado = {
              pipsRiesgo,
              pipsRecompensa,
              riesgoUSD,
              gananciaUSD,
              relacion,
              recomendacion,
              colorClass,
              direccion: this.direccion,
            };

            // Mostrar notificación de éxito
            this.showNotification(
              relacion >= 2 ? "success" : relacion >= 1 ? "warning" : "error",
              "Simulación completada",
              `Relación riesgo/recompensa: ${relacion.toFixed(2)}`
            );
          },
          cargarUltimaSimulacion() {
            try {
              const ultimoResultado = window.localStorage.getItem(
                "simulador_ultimo_resultado"
              );
              if (ultimoResultado) {
                const datos = JSON.parse(ultimoResultado);
                this.pair = datos.pair;
                this.direccion = datos.direccion;
                this.lote = datos.lote;
                this.entrada = datos.entrada;
                this.stop = datos.stop;
                this.take = datos.take;
                this.showNotification(
                  "info",
                  "Simulación anterior cargada",
                  "Se han recuperado los valores de tu última simulación."
                );
              }
            } catch (e) {
              console.warn("Error cargando última simulación:", e);
              this.showNotification(
                "error",
                "Error al cargar",
                "No se pudo recuperar la última simulación."
              );
            }
          },
          limpiarFormulario() {
            this.pair = "";
            this.direccion = "compra";
            this.lote = null;
            this.entrada = null;
            this.stop = null;
            this.take = null;
            this.resultado = null;
            this.errors = {
              pair: "",
              direccion: "",
              lote: "",
              entrada: "",
              stop: "",
              take: "",
            };

            try {
              // Limpiar localStorage
              const keysToRemove = [
                "simulador_pair",
                "simulador_direccion",
                "simulador_numero_lote",
                "simulador_numero_entrada",
                "simulador_numero_stop",
                "simulador_numero_take",
                "simulador_ultimo_resultado",
              ];
              keysToRemove.forEach((key) =>
                window.localStorage.removeItem(key)
              );

              this.showNotification(
                "success",
                "Formulario limpiado",
                "Se han eliminado todos los valores."
              );
            } catch (e) {
              console.warn("Error limpiando localStorage:", e);
            }
          },
          setStorageValue(key, value) {
            try {
              if (value === null || value === "") {
                window.localStorage.removeItem(key);
              } else {
                window.localStorage.setItem(key, value);
              }
            } catch (e) {
              console.warn("Error guardando en localStorage:", e);
            }
          },
        },
        watch: {
          pair(newVal) {
            this.updateInputSteps();
            this.setStorageValue("simulador_pair", newVal);
          },
          direccion(newVal) {
            this.setStorageValue("simulador_direccion", newVal);
          },
          lote(newVal) {
            this.setStorageValue("simulador_numero_lote", newVal);
          },
          entrada(newVal) {
            this.setStorageValue("simulador_numero_entrada", newVal);
          },
          stop(newVal) {
            this.setStorageValue("simulador_numero_stop", newVal);
          },
          take(newVal) {
            this.setStorageValue("simulador_numero_take", newVal);
          },
          resultado(newVal) {
            if (newVal) {
              try {
                const resultadoGuardado = {
                  pair: this.pair,
                  direccion: this.direccion,
                  lote: this.lote,
                  entrada: this.entrada,
                  stop: this.stop,
                  take: this.take,
                  timestamp: new Date().toISOString(),
                  ...newVal,
                };

                // Guardar el último resultado
                window.localStorage.setItem(
                  "simulador_ultimo_resultado",
                  JSON.stringify(resultadoGuardado)
                );

                // Guardar en el historial (manteniendo los últimos 10)
                const historial = JSON.parse(
                  window.localStorage.getItem("simulador_historial") || "[]"
                );
                historial.unshift(resultadoGuardado);
                historial.splice(10); // Mantener solo los últimos 10
                window.localStorage.setItem(
                  "simulador_historial",
                  JSON.stringify(historial)
                );
              } catch (e) {
                console.warn("Error guardando resultado:", e);
              }
            }
          },
        },
        mounted() {
          lucide.createIcons();

          // Comprobar si hay simulación guardada de forma segura
          try {
            const ultimoResultado = window.localStorage.getItem(
              "simulador_ultimo_resultado"
            );
            if (ultimoResultado) {
              this.showNotification(
                "info",
                "Simulación anterior disponible",
                'Puedes cargar tu última simulación usando el botón "Cargar última"'
              );
            }
          } catch (e) {
            console.warn("Error comprobando simulación guardada:", e);
          }
        },
      }).mount("#app");
    </script>
  </body>
</html>
